<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>VIP Go mu-plugins</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="../">
    <link rel="icon" href="images/favicon.ico"/>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/base.css">
            <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="css/template.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/themes/prism-okaidia.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.css">
            <script src="js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-header phpdocumentor-section">
    <h1 class="phpdocumentor-title"><a href="" class="phpdocumentor-title__link">VIP Go mu-plugins</a><span class="title-separator">/</span>mu-plugins</h1>
    <input class="phpdocumentor-header__menu-button" type="checkbox" id="menu-button" name="menu-button" />
    <label class="phpdocumentor-header__menu-icon" for="menu-button">
        <i class="fas fa-bars"></i>
    </label>
    <section data-search-form class="phpdocumentor-search">
    <label>
        <span class="visually-hidden">Search for</span>
        <svg class="phpdocumentor-search__icon" width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="7.5" cy="7.5" r="6.5" stroke="currentColor" stroke-width="2"/>
            <line x1="12.4892" y1="12.2727" x2="19.1559" y2="18.9393" stroke="currentColor" stroke-width="3"/>
        </svg>
        <input type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading .." disabled />
    </label>
</section>

    <nav class="phpdocumentor-topnav">
    <ul class="phpdocumentor-topnav__menu">
        </ul>
</nav>
</header>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <input class="phpdocumentor-sidebar__menu-button" type="checkbox" id="sidebar-button" name="sidebar-button" />
<label class="phpdocumentor-sidebar__menu-icon" for="sidebar-button">
    Menu
</label>
<aside class="phpdocumentor-column -four phpdocumentor-sidebar">
        
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="namespaces/automattic-wp.html"><abbr title="\Automattic\WP">WP</abbr></a></li>
                                            <li><a href="namespaces/automattic-vip.html"><abbr title="\Automattic\VIP">VIP</abbr></a></li>
                                    </ul>
                            <h4 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/tubalmartin.html"><abbr title="\tubalmartin">tubalmartin</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="namespaces/tubalmartin-cssmin.html"><abbr title="\tubalmartin\CssMin">CssMin</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/VIP.html"><abbr title="\VIP">VIP</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/a8c.html"><abbr title="\a8c">a8c</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/a8c-Cron.html"><abbr title="\a8c\Cron">Cron</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/Http.html"><abbr title="\Http">Http</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/Http-Concat.html"><abbr title="\Http\Concat">Concat</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/ES.html"><abbr title="\ES">ES</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/ES-WP.html"><abbr title="\ES\WP">WP</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/wp.html"><abbr title="\wp">wp</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/wp-cli.html"><abbr title="\wp\cli">cli</abbr></a></li>
                            </ul>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="hooks/hooks.html">Hooks</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">searchpress.php</h2>

            <p class="phpdocumentor-summary">ES_WP_Query adapters: Searchpress adapter</p>

    <section class="phpdocumentor-description"></section>






<h3 id="interfaces_class_traits">
    Interfaces, Classes and Traits
    <a href="#interfaces_class_traits" class="headerlink"><i class="fas fa-link"></i></a>
</h3>

<dl class="phpdocumentor-table-of-contents">
    
            <dt class="phpdocumentor-table-of-contents__entry -class"><a href="classes/ES-WP-Query.html"><abbr title="\ES_WP_Query">ES_WP_Query</abbr></a></dt>
        <dd>An adapter for SearchPress.</dd>
    
    </dl>


<h3 id="toc">
    Table of Contents
    <a href="#toc" class="headerlink"><i class="fas fa-link"></i></a>
</h3>

<dl class="phpdocumentor-table-of-contents">
                        <dt class="phpdocumentor-table-of-contents__entry -function -">
    <a href="namespaces/default.html#function_sp_es_field_map">sp_es_field_map()</a>
    <span>
                        &nbsp;: array&lt;string|int, mixed&gt;    </span>
</dt>
<dd>Provides a mapping between WordPress fields and Elasticsearch DSL fields.</dd>

            <dt class="phpdocumentor-table-of-contents__entry -function -">
    <a href="namespaces/default.html#function_es_wp_query_verify_es_is_running">es_wp_query_verify_es_is_running()</a>
    <span>
                        &nbsp;: bool    </span>
</dt>
<dd>Verifies that the Elasticsearch server is up and accepting connections.</dd>

            <dt class="phpdocumentor-table-of-contents__entry -function -">
    <a href="namespaces/default.html#function_sp_adapter_verify_response_code">sp_adapter_verify_response_code()</a>
    <span>
                        &nbsp;: mixed    </span>
</dt>
<dd></dd>

            <dt class="phpdocumentor-table-of-contents__entry -function -">
    <a href="namespaces/default.html#function_es_wp_query_index_test_data">es_wp_query_index_test_data()</a>
    <span>
                        &nbsp;: mixed    </span>
</dt>
<dd>A function to make test data available in the index.</dd>

    </dl>



        

            <section class="phpdocumentor-functions">
        <h3 class="phpdocumentor-elements__header" id="functions">
            Functions
            <a href="files/search-es-wp-query-adapters-searchpress.html#functions" class="headerlink"><i class="fas fa-link"></i></a>
        </h3>
                    <article class="phpdocumentor-element -function - ">
    <h4 class="phpdocumentor-element__name" id="function_sp_es_field_map">
        sp_es_field_map()
        <a href="namespaces/default.html#function_sp_es_field_map" class="headerlink"><i class="fas fa-link"></i></a>
    </h4>
    <aside class="phpdocumentor-element-found-in">
    <abbr class="phpdocumentor-element-found-in__file" title="search/es-wp-query/adapters/searchpress.php"><a href="files/search-es-wp-query-adapters-searchpress.html"><abbr title="search/es-wp-query/adapters/searchpress.php">searchpress.php</abbr></a></abbr>
    :
    <span class="phpdocumentor-element-found-in__line">33</span>
</aside>

        <p class="phpdocumentor-summary">Provides a mapping between WordPress fields and Elasticsearch DSL fields.</p>

    <code class="phpdocumentor-code phpdocumentor-signature ">
    <span class="phpdocumentor-signature__visibility"></span>
                <span class="phpdocumentor-signature__name">sp_es_field_map</span><span>(</span><span class="phpdocumentor-signature__argument"><span class="phpdocumentor-signature__argument__return-type">array&lt;string|int, mixed&gt;&nbsp;</span><span class="phpdocumentor-signature__argument__name">$es_map</span></span><span>)</span><span> : </span><span class="phpdocumentor-signature__response_type">array&lt;string|int, mixed&gt;</span></code>

        <section class="phpdocumentor-description"></section>

        <h5 class="phpdocumentor-argument-list__heading">Parameters</h5>
    <dl class="phpdocumentor-argument-list">
                    <dt class="phpdocumentor-argument-list__entry">
                <span class="phpdocumentor-signature__argument__name">$es_map</span>
                : <span class="phpdocumentor-signature__argument__return-type">array&lt;string|int, mixed&gt;</span>
                            </dt>
            <dd class="phpdocumentor-argument-list__definition">
                    <section class="phpdocumentor-description"><p>Custom mappings to merge with the defaults.</p>
</section>

            </dd>
            </dl>

    

    
</article>
                    <article class="phpdocumentor-element -function - ">
    <h4 class="phpdocumentor-element__name" id="function_es_wp_query_verify_es_is_running">
        es_wp_query_verify_es_is_running()
        <a href="namespaces/default.html#function_es_wp_query_verify_es_is_running" class="headerlink"><i class="fas fa-link"></i></a>
    </h4>
    <aside class="phpdocumentor-element-found-in">
    <abbr class="phpdocumentor-element-found-in__file" title="search/es-wp-query/adapters/searchpress.php"><a href="files/search-es-wp-query-adapters-searchpress.html"><abbr title="search/es-wp-query/adapters/searchpress.php">searchpress.php</abbr></a></abbr>
    :
    <span class="phpdocumentor-element-found-in__line">105</span>
</aside>

        <p class="phpdocumentor-summary">Verifies that the Elasticsearch server is up and accepting connections.</p>

    <code class="phpdocumentor-code phpdocumentor-signature ">
    <span class="phpdocumentor-signature__visibility"></span>
                <span class="phpdocumentor-signature__name">es_wp_query_verify_es_is_running</span><span>(</span><span class="phpdocumentor-signature__argument"><span>[</span><span class="phpdocumentor-signature__argument__return-type">int&nbsp;</span><span class="phpdocumentor-signature__argument__name">$tries</span><span> = </span><span class="phpdocumentor-signature__argument__default-value">5</span><span> ]</span></span><span class="phpdocumentor-signature__argument"><span>[</span><span>, </span><span class="phpdocumentor-signature__argument__return-type">int&nbsp;</span><span class="phpdocumentor-signature__argument__name">$sleep</span><span> = </span><span class="phpdocumentor-signature__argument__default-value">3</span><span> ]</span></span><span>)</span><span> : </span><span class="phpdocumentor-signature__response_type">bool</span></code>

        <section class="phpdocumentor-description"></section>

        <h5 class="phpdocumentor-argument-list__heading">Parameters</h5>
    <dl class="phpdocumentor-argument-list">
                    <dt class="phpdocumentor-argument-list__entry">
                <span class="phpdocumentor-signature__argument__name">$tries</span>
                : <span class="phpdocumentor-signature__argument__return-type">int</span>
                 = <span class="phpdocumentor-signature__argument__default-value">5</span>            </dt>
            <dd class="phpdocumentor-argument-list__definition">
                    <section class="phpdocumentor-description"><p>The number of retries to attempt.</p>
</section>

            </dd>
                    <dt class="phpdocumentor-argument-list__entry">
                <span class="phpdocumentor-signature__argument__name">$sleep</span>
                : <span class="phpdocumentor-signature__argument__return-type">int</span>
                 = <span class="phpdocumentor-signature__argument__default-value">3</span>            </dt>
            <dd class="phpdocumentor-argument-list__definition">
                    <section class="phpdocumentor-description"><p>The amount of time to sleep between retries.</p>
</section>

            </dd>
            </dl>

    
    <h5 class="phpdocumentor-tag-list__heading" id="tags">
        Tags
        <a href="#tags" class="headerlink"><i class="fas fa-link"></i></a>
    </h5>
    <dl class="phpdocumentor-tag-list">
                                    <dt class="phpdocumentor-tag-list__entry">
                    <span class="phpdocumentor-tag__name">throws</span>
                </dt>
                <dd class="phpdocumentor-tag-list__definition">
                                                                <span class="phpdocumentor-tag-link"><a href="classes/ES-Index-Exception.html"><abbr title="\ES_Index_Exception">ES_Index_Exception</abbr></a></span>
                                                            
                                                 <section class="phpdocumentor-description"><p>If the indexing operation fails.</p>
</section>

                                    </dd>
                        </dl>

    
</article>
                    <article class="phpdocumentor-element -function - ">
    <h4 class="phpdocumentor-element__name" id="function_sp_adapter_verify_response_code">
        sp_adapter_verify_response_code()
        <a href="namespaces/default.html#function_sp_adapter_verify_response_code" class="headerlink"><i class="fas fa-link"></i></a>
    </h4>
    <aside class="phpdocumentor-element-found-in">
    <abbr class="phpdocumentor-element-found-in__file" title="search/es-wp-query/adapters/searchpress.php"><a href="files/search-es-wp-query-adapters-searchpress.html"><abbr title="search/es-wp-query/adapters/searchpress.php">searchpress.php</abbr></a></abbr>
    :
    <span class="phpdocumentor-element-found-in__line">161</span>
</aside>

    
    <code class="phpdocumentor-code phpdocumentor-signature ">
    <span class="phpdocumentor-signature__visibility"></span>
                <span class="phpdocumentor-signature__name">sp_adapter_verify_response_code</span><span>(</span><span class="phpdocumentor-signature__argument"><span class="phpdocumentor-signature__argument__return-type">mixed&nbsp;</span><span class="phpdocumentor-signature__argument__name">$response</span></span><span>)</span><span> : </span><span class="phpdocumentor-signature__response_type">mixed</span></code>

    
        <h5 class="phpdocumentor-argument-list__heading">Parameters</h5>
    <dl class="phpdocumentor-argument-list">
                    <dt class="phpdocumentor-argument-list__entry">
                <span class="phpdocumentor-signature__argument__name">$response</span>
                : <span class="phpdocumentor-signature__argument__return-type">mixed</span>
                            </dt>
            <dd class="phpdocumentor-argument-list__definition">
                
            </dd>
            </dl>

    

    
</article>
                    <article class="phpdocumentor-element -function - ">
    <h4 class="phpdocumentor-element__name" id="function_es_wp_query_index_test_data">
        es_wp_query_index_test_data()
        <a href="namespaces/default.html#function_es_wp_query_index_test_data" class="headerlink"><i class="fas fa-link"></i></a>
    </h4>
    <aside class="phpdocumentor-element-found-in">
    <abbr class="phpdocumentor-element-found-in__file" title="search/es-wp-query/adapters/searchpress.php"><a href="files/search-es-wp-query-adapters-searchpress.html"><abbr title="search/es-wp-query/adapters/searchpress.php">searchpress.php</abbr></a></abbr>
    :
    <span class="phpdocumentor-element-found-in__line">174</span>
</aside>

        <p class="phpdocumentor-summary">A function to make test data available in the index.</p>

    <code class="phpdocumentor-code phpdocumentor-signature ">
    <span class="phpdocumentor-signature__visibility"></span>
                <span class="phpdocumentor-signature__name">es_wp_query_index_test_data</span><span>(</span><span>)</span><span> : </span><span class="phpdocumentor-signature__response_type">mixed</span></code>

        <section class="phpdocumentor-description"></section>

    
    

    
</article>
            </section>

                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php // phpcs:ignore WordPress.Files.FileName.InvalidClassFileName
/**
 * ES_WP_Query adapters: Searchpress adapter
 *
 * @package ES_WP_Query
 */

// phpcs:disable Generic.Classes.DuplicateClassName.Found

/**
 * An adapter for SearchPress.
 */
class ES_WP_Query extends ES_WP_Query_Wrapper {

	/**
	 * Implements the abstract function query_es from ES_WP_Query_Wrapper.
	 *
	 * @param array $es_args Arguments to pass to the Elasticsearch server.
	 * @access protected
	 * @return array The response from the Elasticsearch server.
	 */
	protected function query_es( $es_args ) {
		return SP_API()-&gt;search( wp_json_encode( $es_args ), array( &#039;output&#039; =&gt; ARRAY_A ) );
	}
}

/**
 * Provides a mapping between WordPress fields and Elasticsearch DSL fields.
 *
 * @param array $es_map Custom mappings to merge with the defaults.
 * @return array
 */
function sp_es_field_map( $es_map ) {
	return wp_parse_args(
		array(
			&#039;post_name&#039;             =&gt; &#039;post_name.raw&#039;,
			&#039;post_title&#039;            =&gt; &#039;post_title.raw&#039;,
			&#039;post_title.analyzed&#039;   =&gt; &#039;post_title&#039;,
			&#039;post_content.analyzed&#039; =&gt; &#039;post_content&#039;,
			&#039;post_author&#039;           =&gt; &#039;post_author.user_id&#039;,
			&#039;post_date&#039;             =&gt; &#039;post_date.date&#039;,
			&#039;post_date_gmt&#039;         =&gt; &#039;post_date_gmt.date&#039;,
			&#039;post_modified&#039;         =&gt; &#039;post_modified.date&#039;,
			&#039;post_modified_gmt&#039;     =&gt; &#039;post_modified_gmt.date&#039;,
			&#039;post_type&#039;             =&gt; &#039;post_type.raw&#039;,
			&#039;post_meta&#039;             =&gt; &#039;post_meta.%s.raw&#039;,
			&#039;post_meta.analyzed&#039;    =&gt; &#039;post_meta.%s.value&#039;,
			&#039;post_meta.signed&#039;      =&gt; &#039;post_meta.%s.long&#039;,
			&#039;post_meta.unsigned&#039;    =&gt; &#039;post_meta.%s.long&#039;,
			&#039;term_name&#039;             =&gt; &#039;terms.%s.name.raw&#039;,
			&#039;term_tt_id&#039;            =&gt; &#039;terms.%s.term_id&#039;,
			&#039;category_name&#039;         =&gt; &#039;terms.%s.name.raw&#039;,
			&#039;category_tt_id&#039;        =&gt; &#039;terms.%s.term_id&#039;,
			&#039;tag_name&#039;              =&gt; &#039;terms.%s.name.raw&#039;,
			&#039;tag_tt_id&#039;             =&gt; &#039;terms.%s.term_id&#039;,
		),
		$es_map
	);
}
add_filter( &#039;es_field_map&#039;, &#039;sp_es_field_map&#039; );

// This section only used for unit tests.
// phpcs:disable WordPress.Security.EscapeOutput.OutputNotEscaped, WordPress.PHP.DevelopmentFunctions.error_log_print_r
if ( defined( &#039;ES_WP_QUERY_TEST_ENV&#039; ) &amp;&amp; ES_WP_QUERY_TEST_ENV ) {

	remove_action( &#039;save_post&#039;, array( SP_Sync_Manager(), &#039;sync_post&#039; ) );
	remove_action( &#039;delete_post&#039;, array( SP_Sync_Manager(), &#039;delete_post&#039; ) );
	remove_action( &#039;trashed_post&#039;, array( SP_Sync_Manager(), &#039;delete_post&#039; ) );

	add_filter(
		&#039;sp_post_allowed_meta&#039;,
		function() {
			return array(
				&#039;numeric_value&#039;    =&gt; array( &#039;long&#039;, &#039;double&#039; ),
				&#039;decimal_value&#039;    =&gt; array( &#039;value&#039;, &#039;long&#039;, &#039;double&#039; ),
				&#039;time&#039;             =&gt; array( &#039;value&#039;, &#039;long&#039; ),
				&#039;foo&#039;              =&gt; array( &#039;value&#039;, &#039;long&#039; ),
				&#039;foo2&#039;             =&gt; array( &#039;value&#039; ),
				&#039;foo3&#039;             =&gt; array( &#039;value&#039; ),
				&#039;foo4&#039;             =&gt; array( &#039;value&#039; ),
				&#039;number_of_colors&#039; =&gt; array( &#039;value&#039;, &#039;long&#039; ),
				&#039;oof&#039;              =&gt; array( &#039;value&#039; ),
				&#039;bar&#039;              =&gt; array( &#039;value&#039; ),
				&#039;bar1&#039;             =&gt; array( &#039;value&#039; ),
				&#039;bar2&#039;             =&gt; array( &#039;value&#039; ),
				&#039;baz&#039;              =&gt; array( &#039;value&#039; ),
				&#039;froo&#039;             =&gt; array( &#039;value&#039; ),
				&#039;tango&#039;            =&gt; array( &#039;value&#039; ),
				&#039;color&#039;            =&gt; array( &#039;value&#039; ),
				&#039;vegetable&#039;        =&gt; array( &#039;value&#039; ),
				&#039;city&#039;             =&gt; array( &#039;value&#039; ),
				&#039;address&#039;          =&gt; array( &#039;value&#039; ),
			);
		}
	);

	/**
	 * Verifies that the Elasticsearch server is up and accepting connections.
	 *
	 * @param int $tries The number of retries to attempt.
	 * @param int $sleep The amount of time to sleep between retries.
	 * @return bool True if the server is up, false if not.
	 * @throws ES_Index_Exception If the indexing operation fails.
	 */
	function es_wp_query_verify_es_is_running( $tries = 5, $sleep = 3 ) {
		// If your ES server is not at localhost:9200, you need to set $_ENV[&#039;SEARCHPRESS_HOST&#039;].
		$host = getenv( &#039;SEARCHPRESS_HOST&#039; );
		if ( empty( $host ) ) {
			$host = &#039;http://localhost:9200&#039;;
		}

		if ( defined( &#039;SP_VERSION&#039; ) ) {
			$sp_version = SP_VERSION;
		} elseif ( defined( &#039;SP_PLUGIN_DIR&#039; ) ) {
			require_once ABSPATH . &#039;/wp-admin/includes/plugin.php&#039;;
			$plugin_data = get_plugin_data( SP_PLUGIN_DIR . &#039;/searchpress.php&#039; );
			$sp_version  = ! empty( $plugin_data[&#039;Version&#039;] ) ? $plugin_data[&#039;Version&#039;] : &#039;[unknown version]&#039;;
		} else {
			$sp_version = &#039;[unknown version]&#039;;
		}

		printf(
			&quot;Testing with SearchPress adapter, using SearchPress version %s and host %s\n&quot;,
			$sp_version,
			$host
		);

		// Make sure ES is running and responding.
		$tries = 5;
		$sleep = 3;
		do {
			$response = wp_remote_get( $host );
			if ( 200 === wp_remote_retrieve_response_code( $response ) ) {
				$body = json_decode( wp_remote_retrieve_body( $response ), true );
				if ( ! empty( $body[&#039;version&#039;][&#039;number&#039;] ) ) {
					printf( &quot;Elasticsearch is up and running, using version %s.\n&quot;, $body[&#039;version&#039;][&#039;number&#039;] );
				}
				break;
			} else {
				printf( &quot;\nInvalid response from ES (%s), sleeping %d seconds and trying again...\n&quot;, wp_remote_retrieve_response_code( $response ), $sleep );
				sleep( $sleep );
			}
		} while ( --$tries );

		// If we didn&#039;t end with a 200 status code, exit
		sp_adapter_verify_response_code( $response );

		$i = 0;
		while ( ! ( $beat = SP_Heartbeat()-&gt;check_beat( true ) ) &amp;&amp; $i++ &lt; 5 ) {
			echo &quot;\nHeartbeat failed, sleeping 2 seconds and trying again...\n&quot;;
			sleep( 2 );
		}
		if ( ! $beat &amp;&amp; ! SP_Heartbeat()-&gt;check_beat( true ) ) {
			echo &quot;\nCould not find a heartbeat!&quot;;
			exit( 1 );
		}

		return true;
	}

	function sp_adapter_verify_response_code( $response ) {
		if ( &#039;200&#039; != wp_remote_retrieve_response_code( $response ) ) {
			printf( &quot;Could not index posts!\nResponse code %s\n&quot;, wp_remote_retrieve_response_code( $response ) );
			if ( is_wp_error( $response ) ) {
				printf( &quot;Message: %s\n&quot;, $response-&gt;get_error_message() );
			}
			exit( 1 );
		}
	}

	/**
	 * A function to make test data available in the index.
	 */
	function es_wp_query_index_test_data() {
		// If your ES server is not at localhost:9200, you need to set $_ENV[&#039;searchpress_host&#039;].
		$host = ! empty( $_ENV[&#039;searchpress_host&#039;] ) ? $_ENV[&#039;searchpress_host&#039;] : &#039;http://localhost:9200&#039;;

		SP_Config()-&gt;update_settings(
			array(
				&#039;active&#039; =&gt; false,
				&#039;host&#039;   =&gt; $host,
			)
		);
		SP_API()-&gt;index = &#039;es-wp-query-tests&#039;;

		SP_Config()-&gt;flush();
		SP_Config()-&gt;create_mapping();

		$posts = get_posts( // phpcs:ignore WordPressVIPMinimum.VIP.RestrictedFunctions.get_posts_get_posts
			array(
				&#039;posts_per_page&#039; =&gt; -1, // phpcs:ignore WordPress.VIP.PostsPerPage.posts_per_page_posts_per_page
				&#039;post_type&#039;      =&gt; &#039;any&#039;,
				&#039;post_status&#039;    =&gt; array_values( get_post_stati() ),
				&#039;orderby&#039;        =&gt; &#039;ID&#039;,
				&#039;order&#039;          =&gt; &#039;ASC&#039;,
			)
		);

		$sp_posts = array();
		foreach ( $posts as $post ) {
			$sp_posts[] = new SP_Post( $post );
		}

		$response = SP_API()-&gt;index_posts( $sp_posts );
		if ( 200 !== intval( SP_API()-&gt;last_request[&#039;response_code&#039;] ) ) {
			echo( &quot;ES response not 200!\n&quot; . print_r( $response, 1 ) );
		} elseif ( ! is_object( $response ) || ! is_array( $response-&gt;items ) ) {
			echo( &quot;Error indexing data! Response:\n&quot; . print_r( $response, 1 ) );
		}

		SP_Config()-&gt;update_settings(
			array(
				&#039;active&#039;    =&gt; true,
				&#039;must_init&#039; =&gt; false,
			)
		);

		SP_API()-&gt;post( &#039;_refresh&#039; );
	}
}
// phpcs:enable WordPress.Security.EscapeOutput.OutputNotEscaped, WordPress.PHP.DevelopmentFunctions.error_log_print_r
</code></pre>
            </article>
                <section data-search-results class="phpdocumentor-search-results phpdocumentor-search-results--hidden">
    <section class="phpdocumentor-search-results__dialog">
        <header class="phpdocumentor-search-results__header">
            <h2 class="phpdocumentor-search-results__title">Search results</h2>
            <button class="phpdocumentor-search-results__close"><i class="fas fa-times"></i></button>
        </header>
        <section class="phpdocumentor-search-results__body">
            <ul class="phpdocumentor-search-results__entries"></ul>
        </section>
    </section>
</section>
            </div>
        </div>
        <a href="files/search-es-wp-query-adapters-searchpress.html#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <script>
        cssVars({});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
</body>
</html>
