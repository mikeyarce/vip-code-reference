<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>VIP Go mu-plugins</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="../">
    <link rel="icon" href="images/favicon.ico"/>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/base.css">
            <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="css/template.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/themes/prism-okaidia.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.css">
            <script src="js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-header phpdocumentor-section">
    <h1 class="phpdocumentor-title"><a href="" class="phpdocumentor-title__link">VIP Go mu-plugins</a><span class="title-separator">/</span>mu-plugins</h1>
    <input class="phpdocumentor-header__menu-button" type="checkbox" id="menu-button" name="menu-button" />
    <label class="phpdocumentor-header__menu-icon" for="menu-button">
        <i class="fas fa-bars"></i>
    </label>
    <section data-search-form class="phpdocumentor-search">
    <label>
        <span class="visually-hidden">Search for</span>
        <svg class="phpdocumentor-search__icon" width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="7.5" cy="7.5" r="6.5" stroke="currentColor" stroke-width="2"/>
            <line x1="12.4892" y1="12.2727" x2="19.1559" y2="18.9393" stroke="currentColor" stroke-width="3"/>
        </svg>
        <input type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading .." disabled />
    </label>
</section>

    <nav class="phpdocumentor-topnav">
    <ul class="phpdocumentor-topnav__menu">
        </ul>
</nav>
</header>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <input class="phpdocumentor-sidebar__menu-button" type="checkbox" id="sidebar-button" name="sidebar-button" />
<label class="phpdocumentor-sidebar__menu-icon" for="sidebar-button">
    Menu
</label>
<aside class="phpdocumentor-column -four phpdocumentor-sidebar">
        
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="namespaces/automattic-wp.html"><abbr title="\Automattic\WP">WP</abbr></a></li>
                                            <li><a href="namespaces/automattic-vip.html"><abbr title="\Automattic\VIP">VIP</abbr></a></li>
                                    </ul>
                            <h4 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/tubalmartin.html"><abbr title="\tubalmartin">tubalmartin</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="namespaces/tubalmartin-cssmin.html"><abbr title="\tubalmartin\CssMin">CssMin</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/VIP.html"><abbr title="\VIP">VIP</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/a8c.html"><abbr title="\a8c">a8c</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/a8c-Cron.html"><abbr title="\a8c\Cron">Cron</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/Http.html"><abbr title="\Http">Http</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/Http-Concat.html"><abbr title="\Http\Concat">Concat</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/ES.html"><abbr title="\ES">ES</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/ES-WP.html"><abbr title="\ES\WP">WP</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/wp.html"><abbr title="\wp">wp</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/wp-cli.html"><abbr title="\wp\cli">cli</abbr></a></li>
                            </ul>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="hooks/hooks.html">Hooks</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-es-wp-tax-query.php</h2>

            <p class="phpdocumentor-summary">ES_WP_Query classes: ES_WP_Tax_Query class</p>

    <section class="phpdocumentor-description"></section>






<h3 id="interfaces_class_traits">
    Interfaces, Classes and Traits
    <a href="#interfaces_class_traits" class="headerlink"><i class="fas fa-link"></i></a>
</h3>

<dl class="phpdocumentor-table-of-contents">
    
            <dt class="phpdocumentor-table-of-contents__entry -class"><a href="classes/ES-WP-Tax-Query.html"><abbr title="\ES_WP_Tax_Query">ES_WP_Tax_Query</abbr></a></dt>
        <dd>Elasticsearch wrapper for WP_Meta_Query</dd>
    
    </dl>





        

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * ES_WP_Query classes: ES_WP_Tax_Query class
 *
 * @package ES_WP_Query
 */

/**
 * Elasticsearch wrapper for WP_Meta_Query
 */
class ES_WP_Tax_Query extends WP_Tax_Query {

	/**
	 * Some object which extends ES_WP_Query_Wrapper.
	 *
	 * @var ES_WP_Query_Wrapper
	 */
	protected $es_query;

	/**
	 * Generates DSL from a tax query.
	 *
	 * @param WP_Tax_Query $tax_query The tax query to transform.
	 * @access public
	 * @return ES_WP_Tax_Query
	 */
	public static function get_from_tax_query( $tax_query ) {
		$q           = new ES_WP_Tax_Query( $tax_query-&gt;queries );
		$q-&gt;relation = $tax_query-&gt;relation;
		return $q;
	}

	/**
	 * Get a (light) ES filter that will always produce no results. This allows
	 * individual tax query clauses to fail without breaking the rest of them.
	 *
	 * @return array ES term query for post_id:0.
	 */
	protected function get_no_results_clause() {
		return $this-&gt;es_query-&gt;dsl_terms( $this-&gt;es_query-&gt;es_map( &#039;post_id&#039; ), 0 );
	}

	/**
	 * Turns an array of tax query parameters into ES Query DSL
	 *
	 * @access public
	 *
	 * @param object $es_query Any object which extends ES_WP_Query_Wrapper.
	 * @return array ES filters
	 */
	public function get_dsl( $es_query ) {
		$this-&gt;es_query = $es_query;

		$filters = $this-&gt;get_dsl_clauses();

		return apply_filters_ref_array( &#039;es_wp_tax_query_dsl&#039;, array( $filters, $this-&gt;queries, $this-&gt;es_query ) );
	}

	/**
	 * Generate ES Filter clauses to be appended to a main query.
	 *
	 * Called by the public {@see ES_WP_Meta_Query::get_dsl()}, this method
	 * is abstracted out to maintain parity with the other Query classes.
	 *
	 * @access protected
	 *
	 * @return array
	 */
	protected function get_dsl_clauses() {
		/*
		 * $queries are passed by reference to
		 * `ES_WP_Meta_Query::get_dsl_for_query()` for recursion. To keep
		 * $this-&gt;queries unaltered, pass a copy.
		 */
		$queries = $this-&gt;queries;
		return $this-&gt;get_dsl_for_query( $queries );
	}

	/**
	 * Generate ES filters for a single query array.
	 *
	 * If nested subqueries are found, this method recurses the tree to produce
	 * the properly nested DSL.
	 *
	 * @access protected
	 *
	 * @param array $query Query to parse, passed by reference.
	 * @return boolarray Array containing nested ES filter clauses on success or
	 *                   false on error.
	 */
	protected function get_dsl_for_query( &amp;$query ) {
		$filters = array();

		foreach ( $query as $key =&gt; &amp;$clause ) {
			if ( &#039;relation&#039; === $key ) {
				$relation = $query[&#039;relation&#039;];
			} elseif ( is_array( $clause ) ) {
				if ( $this-&gt;is_first_order_clause( $clause ) ) {
					// This is a first-order clause.
					$filters[] = $this-&gt;get_dsl_for_clause( $clause, $query );
				} else {
					// This is a subquery, so we recurse.
					$filters[] = $this-&gt;get_dsl_for_query( $clause );
				}
			}
		}

		// Filter to remove empties.
		$filters = array_filter( $filters );

		if ( ! empty( $relation ) &amp;&amp; &#039;or&#039; === strtolower( $relation ) ) {
			$relation = &#039;should&#039;;
		} else {
			$relation = &#039;filter&#039;;
		}

		if ( count( $filters ) &gt; 1 ) {
			$filters = array(
				&#039;bool&#039; =&gt; array(
					$relation =&gt; $filters,
				),
			);
		} elseif ( ! empty( $filters ) ) {
			$filters = reset( $filters );
		}

		return $filters;
	}

	/**
	 * Generate ES filter clauses for a first-order query clause.
	 *
	 * &quot;First-order&quot; means that it&#039;s an array with a &#039;key&#039; or &#039;value&#039;.
	 *
	 * @access public
	 *
	 * @param array $clause Query clause, passed by reference.
	 * @param array $query Parent query array.
	 * @return bool|array ES filter clause on success, or false on error.
	 */
	public function get_dsl_for_clause( &amp;$clause, $query ) {
		$current_filter = null;

		$this-&gt;clean_query( $clause );

		if ( is_wp_error( $clause ) ) {
			return $this-&gt;get_no_results_clause();
		}

		// If the comparison is EXISTS or NOT EXISTS, handle that first since
		// it&#039;s quick and easy.
		if ( &#039;EXISTS&#039; === $clause[&#039;operator&#039;] || &#039;NOT EXISTS&#039; === $clause[&#039;operator&#039;] ) {
			if ( empty( $clause[&#039;taxonomy&#039;] ) ) {
				return $this-&gt;get_no_results_clause();
			}

			if ( &#039;EXISTS&#039; === $clause[&#039;operator&#039;] ) {
				return $this-&gt;es_query-&gt;dsl_exists( $this-&gt;es_query-&gt;tax_map( $clause[&#039;taxonomy&#039;], &#039;term_id&#039; ) );
			} elseif ( &#039;NOT EXISTS&#039; === $clause[&#039;operator&#039;] ) {
				return $this-&gt;es_query-&gt;dsl_missing( $this-&gt;es_query-&gt;tax_map( $clause[&#039;taxonomy&#039;], &#039;term_id&#039; ) );
			}
		}

		if ( &#039;AND&#039; === $clause[&#039;operator&#039;] ) {
			$terms_method = array( $this-&gt;es_query, &#039;dsl_all_terms&#039; );
		} else {
			$terms_method = array( $this-&gt;es_query, &#039;dsl_terms&#039; );
		}

		if ( empty( $clause[&#039;terms&#039;] ) ) {
			if ( &#039;NOT IN&#039; === $clause[&#039;operator&#039;] || &#039;AND&#039; === $clause[&#039;operator&#039;] ) {
				return array();
			} elseif ( &#039;IN&#039; === $clause[&#039;operator&#039;] ) {
				return $this-&gt;get_no_results_clause();
			}
		}

		switch ( $clause[&#039;field&#039;] ) {
			case &#039;slug&#039;:
			case &#039;name&#039;:
				foreach ( $clause[&#039;terms&#039;] as &amp;$term ) {
					/*
					 * 0 is the $term_id parameter. We don&#039;t have a term ID yet, but it doesn&#039;t
					 * matter because `sanitize_term_field()` ignores the $term_id param when the
					 * context is &#039;db&#039;.
					 */
					$term = sanitize_term_field( $clause[&#039;field&#039;], $term, 0, $clause[&#039;taxonomy&#039;], &#039;db&#039; );

					/**
					 * Allow adapters to normalize term value (like `strtolower` if mapping to
					 * `raw_lc`).
					 *
					 * The dynamic portion of the filter name, `$clause[&#039;field&#039;]`, refers to the
					 * term field.
					 *
					 * @param mixed  $term     Term&#039;s slug or name sanitized using
					 *                         `sanitize_term_field` function for db context.
					 * @param string $taxonomy Term&#039;s taxonomy slug.
					 */
					$term = apply_filters( &quot;es_tax_query_term_{$clause[&#039;field&#039;]}&quot;, $term, $clause[&#039;taxonomy&#039;] );

				}
				$current_filter = call_user_func( $terms_method, $this-&gt;es_query-&gt;tax_map( $clause[&#039;taxonomy&#039;], &#039;term_&#039; . $clause[&#039;field&#039;] ), $clause[&#039;terms&#039;] );
				break;

			case &#039;term_taxonomy_id&#039;:
				if ( ! empty( $clause[&#039;taxonomy&#039;] ) ) {
					$current_filter = call_user_func( $terms_method, $this-&gt;es_query-&gt;tax_map( $clause[&#039;taxonomy&#039;], &#039;term_tt_id&#039; ), $clause[&#039;terms&#039;] );
				} else {
					$matches = array();
					foreach ( $clause[&#039;terms&#039;] as &amp;$term ) {
						$matches[] = $this-&gt;es_query-&gt;dsl_multi_match( $this-&gt;es_query-&gt;tax_map( &#039;*&#039;, &#039;term_tt_id&#039; ), $term );
					}
					if ( count( $matches ) &gt; 1 ) {
						$current_filter = array(
							&#039;bool&#039; =&gt; array(
								( &#039;AND&#039; === $clause[&#039;operator&#039;] ? &#039;filter&#039; : &#039;should&#039; ) =&gt; $matches,
							),
						);
					} else {
						$current_filter = reset( $matches );
					}
				}

				break;

			default:
				$terms          = array_map( &#039;absint&#039;, array_values( $clause[&#039;terms&#039;] ) );
				$current_filter = call_user_func( $terms_method, $this-&gt;es_query-&gt;tax_map( $clause[&#039;taxonomy&#039;], &#039;term_id&#039; ), $terms );
				break;
		}

		if ( &#039;NOT IN&#039; === $clause[&#039;operator&#039;] ) {
			return array(
				&#039;bool&#039; =&gt; array(
					&#039;must_not&#039; =&gt; $current_filter,
				),
			);
		} else {
			return $current_filter;
		}
	}

	/**
	 * Validates a single query.
	 *
	 * This is copied from core verbatim, because the core method is private.
	 *
	 * @access private
	 *
	 * @param array $query The single query.
	 */
	private function clean_query( &amp;$query ) {
		if ( empty( $query[&#039;taxonomy&#039;] ) ) {
			if ( &#039;term_taxonomy_id&#039; !== $query[&#039;field&#039;] ) {
				$query = new WP_Error( &#039;Invalid taxonomy&#039; );
				return;
			}

			// So long as there are shared terms, include_children requires that a taxonomy is set.
			$query[&#039;include_children&#039;] = false;
		} elseif ( ! taxonomy_exists( $query[&#039;taxonomy&#039;] ) ) {
			$query = new WP_Error( &#039;Invalid taxonomy&#039; );
			return;
		}

		$query[&#039;terms&#039;] = array_unique( (array) $query[&#039;terms&#039;] );

		if ( is_taxonomy_hierarchical( $query[&#039;taxonomy&#039;] ) &amp;&amp; $query[&#039;include_children&#039;] ) {
			$this-&gt;transform_query( $query, &#039;term_id&#039; );

			if ( is_wp_error( $query ) ) {
				return;
			}

			$children = array();
			foreach ( $query[&#039;terms&#039;] as $term ) {
				$children   = array_merge( $children, get_term_children( $term, $query[&#039;taxonomy&#039;] ) );
				$children[] = $term;
			}
			$query[&#039;terms&#039;] = $children;
		}

		// If we have a term_taxonomy_id, use mysql, as that&#039;s almost certainly not stored in ES.
		// However, you can override this.
		if ( &#039;term_taxonomy_id&#039; === $query[&#039;field&#039;] &amp;&amp; ! empty( $query[&#039;taxonomy&#039;] ) ) {
			if ( apply_filters( &#039;es_use_mysql_for_term_taxonomy_id&#039;, true ) ) {
				$this-&gt;transform_query( $query, &#039;term_id&#039; );
			}
		}
	}

	/**
	 * Transforms a single query, from one field to another.
	 *
	 * @param array  $query           The single query.
	 * @param string $resulting_field The resulting field.
	 */
	public function transform_query( &amp;$query, $resulting_field ) {
		global $wpdb;

		if ( empty( $query[&#039;terms&#039;] ) ) {
			return;
		}

		if ( $query[&#039;field&#039;] === $resulting_field ) {
			return;
		}

		$resulting_field = sanitize_key( $resulting_field );

		// phpcs:disable WordPress.DB.PreparedSQL.NotPrepared, WordPress.VIP.DirectDatabaseQuery.NoCaching, WordPress.VIP.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching, WordPress.DB.DirectDatabaseQuery.DirectQuery
		switch ( $query[&#039;field&#039;] ) {
			case &#039;slug&#039;:
			case &#039;name&#039;:
				$terms = &quot;&#039;&quot; . implode( &quot;&#039;,&#039;&quot;, array_map( &#039;sanitize_title_for_query&#039;, $query[&#039;terms&#039;] ) ) . &quot;&#039;&quot;;
				$terms = $wpdb-&gt;get_col(
					&quot;
					SELECT $wpdb-&gt;term_taxonomy.$resulting_field
					FROM $wpdb-&gt;term_taxonomy
					INNER JOIN $wpdb-&gt;terms USING (term_id)
					WHERE taxonomy = &#039;{$query[&#039;taxonomy&#039;]}&#039;
					AND $wpdb-&gt;terms.{$query[&#039;field&#039;]} IN ($terms)
				&quot; 
				);
				break;
			case &#039;term_taxonomy_id&#039;:
				$terms = implode( &#039;,&#039;, array_map( &#039;intval&#039;, $query[&#039;terms&#039;] ) );
				$terms = $wpdb-&gt;get_col(
					&quot;
					SELECT $resulting_field
					FROM $wpdb-&gt;term_taxonomy
					WHERE term_taxonomy_id IN ($terms)
				&quot; 
				);
				break;
			default:
				$terms = implode( &#039;,&#039;, array_map( &#039;intval&#039;, $query[&#039;terms&#039;] ) );
				$terms = $wpdb-&gt;get_col(
					&quot;
					SELECT $resulting_field
					FROM $wpdb-&gt;term_taxonomy
					WHERE taxonomy = &#039;{$query[&#039;taxonomy&#039;]}&#039;
					AND term_id IN ($terms)
				&quot; 
				);
		}
		// phpcs:enable WordPress.DB.PreparedSQL.NotPrepared, WordPress.VIP.DirectDatabaseQuery.NoCaching, WordPress.VIP.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching, WordPress.DB.DirectDatabaseQuery.DirectQuery

		if ( &#039;AND&#039; === $query[&#039;operator&#039;] &amp;&amp; count( $terms ) &lt; count( $query[&#039;terms&#039;] ) ) {
			$query = new WP_Error( &#039;Inexistent terms&#039; );
			return;
		}

		$query[&#039;terms&#039;] = $terms;
		$query[&#039;field&#039;] = $resulting_field;
	}
}
</code></pre>
            </article>
                <section data-search-results class="phpdocumentor-search-results phpdocumentor-search-results--hidden">
    <section class="phpdocumentor-search-results__dialog">
        <header class="phpdocumentor-search-results__header">
            <h2 class="phpdocumentor-search-results__title">Search results</h2>
            <button class="phpdocumentor-search-results__close"><i class="fas fa-times"></i></button>
        </header>
        <section class="phpdocumentor-search-results__body">
            <ul class="phpdocumentor-search-results__entries"></ul>
        </section>
    </section>
</section>
            </div>
        </div>
        <a href="files/search-es-wp-query-class-es-wp-tax-query.html#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <script>
        cssVars({});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
</body>
</html>
