<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>VIP Go mu-plugins</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="../">
    <link rel="icon" href="images/favicon.ico"/>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/base.css">
            <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="css/template.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/themes/prism-okaidia.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.css">
            <script src="js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-header phpdocumentor-section">
    <h1 class="phpdocumentor-title"><a href="" class="phpdocumentor-title__link">VIP Go mu-plugins</a><span class="title-separator">/</span>mu-plugins</h1>
    <input class="phpdocumentor-header__menu-button" type="checkbox" id="menu-button" name="menu-button" />
    <label class="phpdocumentor-header__menu-icon" for="menu-button">
        <i class="fas fa-bars"></i>
    </label>
    <section data-search-form class="phpdocumentor-search">
    <label>
        <span class="visually-hidden">Search for</span>
        <svg class="phpdocumentor-search__icon" width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="7.5" cy="7.5" r="6.5" stroke="currentColor" stroke-width="2"/>
            <line x1="12.4892" y1="12.2727" x2="19.1559" y2="18.9393" stroke="currentColor" stroke-width="3"/>
        </svg>
        <input type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading .." disabled />
    </label>
</section>

    <nav class="phpdocumentor-topnav">
    <ul class="phpdocumentor-topnav__menu">
        </ul>
</nav>
</header>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <input class="phpdocumentor-sidebar__menu-button" type="checkbox" id="sidebar-button" name="sidebar-button" />
<label class="phpdocumentor-sidebar__menu-icon" for="sidebar-button">
    Menu
</label>
<aside class="phpdocumentor-column -four phpdocumentor-sidebar">
        
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="namespaces/automattic-wp.html"><abbr title="\Automattic\WP">WP</abbr></a></li>
                                            <li><a href="namespaces/automattic-vip.html"><abbr title="\Automattic\VIP">VIP</abbr></a></li>
                                    </ul>
                            <h4 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/tubalmartin.html"><abbr title="\tubalmartin">tubalmartin</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="namespaces/tubalmartin-cssmin.html"><abbr title="\tubalmartin\CssMin">CssMin</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/VIP.html"><abbr title="\VIP">VIP</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/a8c.html"><abbr title="\a8c">a8c</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/a8c-Cron.html"><abbr title="\a8c\Cron">Cron</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/Http.html"><abbr title="\Http">Http</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/Http-Concat.html"><abbr title="\Http\Concat">Concat</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/ES.html"><abbr title="\ES">ES</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/ES-WP.html"><abbr title="\ES\WP">WP</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/wp.html"><abbr title="\wp">wp</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/wp-cli.html"><abbr title="\wp\cli">cli</abbr></a></li>
                            </ul>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="hooks/hooks.html">Hooks</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-events-store-tests.php</h2>

            <p class="phpdocumentor-summary">Test Events Store, which uses a custom table</p>

    <section class="phpdocumentor-description"></section>






<h3 id="interfaces_class_traits">
    Interfaces, Classes and Traits
    <a href="#interfaces_class_traits" class="headerlink"><i class="fas fa-link"></i></a>
</h3>

<dl class="phpdocumentor-table-of-contents">
    
            <dt class="phpdocumentor-table-of-contents__entry -class"><a href="classes/Automattic-WP-Cron-Control-Tests-Events-Store-Tests.html"><abbr title="\Automattic\WP\Cron_Control\Tests\Events_Store_Tests">Events_Store_Tests</abbr></a></dt>
        <dd>Events Store Tests</dd>
    
    </dl>





        

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * Test Events Store, which uses a custom table
 *
 * @package a8c_Cron_Control
 */

namespace Automattic\WP\Cron_Control\Tests;

/**
 * Events Store Tests
 */
class Events_Store_Tests extends \WP_UnitTestCase {
	/**
	 * Prepare test environment
	 */
	function setUp() {
		parent::setUp();

		// make sure the schedule is clear.
		_set_cron_array( array() );
	}

	/**
	 * Clean up after our tests
	 */
	function tearDown() {
		// make sure the schedule is clear.
		_set_cron_array( array() );

		parent::tearDown();
	}

	/**
	 * Custom table exists
	 */
	function test_table_exists() {
		global $wpdb;

		$table_name = Utils::get_table_name();

		$this-&gt;assertEquals( count( $wpdb-&gt;get_col( $wpdb-&gt;prepare( &#039;SHOW TABLES LIKE %s&#039;, $table_name ) ) ), 1 );
	}

	/**
	 * Check that an event is stored properly in table
	 */
	function test_events_exist() {
		global $wpdb;

		$event      = Utils::create_test_event();
		$table_name = Utils::get_table_name();

		$entry = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT * FROM {$table_name} WHERE timestamp = %d AND action = %s AND instance = %s AND status = %s LIMIT 1&quot;, $event[&#039;timestamp&#039;], $event[&#039;action&#039;], md5( maybe_serialize( $event[&#039;args&#039;] ) ), \Automattic\WP\Cron_Control\Events_Store::STATUS_PENDING ) ); // Cannot prepare table name. @codingStandardsIgnoreLine

		$this-&gt;assertEquals( count( $entry ), 1 );

		$entry = array_shift( $entry );

		$this-&gt;assertEquals( $event[&#039;action&#039;], $entry-&gt;action );
		$this-&gt;assertEquals( md5( maybe_serialize( $event[&#039;args&#039;] ) ), $entry-&gt;instance );
		Utils::compare_arrays( $event[&#039;args&#039;], maybe_unserialize( $entry-&gt;args ), $this );
	}

	/**
	 * Check format of filtered array returned from table
	 */
	function test_filter_cron_option_get() {
		$event = Utils::create_test_event();

		$cron = get_option( &#039;cron&#039; );

		// Core versions the cron option (see `_upgrade_cron_array()`).
		// Without this in the filtered result, all events continually requeue as Core tries to &quot;upgrade&quot; the option.
		$this-&gt;assertArrayHasKey( &#039;version&#039;, $cron );
		$this-&gt;assertEquals( $cron[&#039;version&#039;], 2 );

		// Validate the remaining structure.
		$cron = \Automattic\WP\Cron_Control\collapse_events_array( $cron );

		foreach ( $cron as $single_cron ) {
			$this-&gt;assertEquals( $single_cron[&#039;timestamp&#039;], $event[&#039;timestamp&#039;] );
			$this-&gt;assertEquals( $single_cron[&#039;action&#039;], $event[&#039;action&#039;] );
			$this-&gt;assertArrayHasKey( &#039;args&#039;, $single_cron );
			$this-&gt;assertArrayHasKey( &#039;schedule&#039;, $single_cron[&#039;args&#039;] );
			$this-&gt;assertArrayHasKey( &#039;args&#039;, $single_cron[&#039;args&#039;] );
			$this-&gt;assertEquals( $single_cron[&#039;args&#039;][&#039;args&#039;], $event[&#039;args&#039;] );
		}
	}

	/**
	 * Test that events are unscheduled correctly using Core functions
	 */
	function test_event_unscheduling_using_core_functions() {
		$first_event  = Utils::create_test_event();
		$second_event = Utils::create_test_event( true );

		$first_event_ts = wp_next_scheduled( $first_event[&#039;action&#039;], $first_event[&#039;args&#039;] );

		$this-&gt;assertEquals( $first_event_ts, $first_event[&#039;timestamp&#039;] );

		wp_unschedule_event( $first_event_ts, $first_event[&#039;action&#039;], $first_event[&#039;args&#039;] );

		$first_event_ts  = wp_next_scheduled( $first_event[&#039;action&#039;], $first_event[&#039;args&#039;] );
		$second_event_ts = wp_next_scheduled( $second_event[&#039;action&#039;], $second_event[&#039;args&#039;] );

		$this-&gt;assertFalse( $first_event_ts );
		$this-&gt;assertEquals( $second_event_ts, $second_event[&#039;timestamp&#039;] );

		wp_unschedule_event( $second_event_ts, $second_event[&#039;action&#039;], $second_event[&#039;args&#039;] );

		$second_event_ts = wp_next_scheduled( $second_event[&#039;action&#039;], $second_event[&#039;args&#039;] );

		$this-&gt;assertFalse( $second_event_ts );
	}

	/**
	 * Test that events are unscheduled correctly by checking the table
	 */
	function test_event_unscheduling_against_event_store() {
		// Schedule two events and prepare their data a bit for further testing.
		$first_event             = Utils::create_test_event();
		$first_event[&#039;instance&#039;] = md5( maybe_serialize( $first_event[&#039;args&#039;] ) );
		$first_event_args        = $first_event[&#039;args&#039;];
		unset( $first_event[&#039;args&#039;] );

		sleep( 2 ); // More-thorough to test with events that don&#039;t have matching timestamps.

		$second_event             = Utils::create_test_event( true );
		$second_event[&#039;instance&#039;] = md5( maybe_serialize( $second_event[&#039;args&#039;] ) );
		$second_event_args        = $second_event[&#039;args&#039;];
		unset( $second_event[&#039;args&#039;] );

		// First, check that posts were created for the two events.
		Utils::compare_arrays( array( $first_event, $second_event ), Utils::get_events_from_store(), $this );

		// Second, unschedule an event and confirm that the post is removed.
		wp_unschedule_event( $first_event[&#039;timestamp&#039;], $first_event[&#039;action&#039;], $first_event_args );

		Utils::compare_arrays( array( $second_event ), Utils::get_events_from_store(), $this );

		// Finally, unschedule the second event and confirm its post is also deleted.
		wp_unschedule_event( $second_event[&#039;timestamp&#039;], $second_event[&#039;action&#039;], $second_event_args );

		$this-&gt;assertEmpty( Utils::get_events_from_store() );
	}

	/**
	 * Test event-cache splitting
	 */
	function test_excessive_event_creation() {
		$timestamp_base = time() + ( 1 * \HOUR_IN_SECONDS );

		$dummy_text = &#039;Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam enim ante, maximus nec nisi ut, finibus ultrices orci. Maecenas suscipit, est eu suscipit sagittis, enim massa dignissim augue, sagittis gravida dolor nulla ut mi. Phasellus venenatis bibendum cursus. Aliquam a erat purus. Nulla elit nunc, egestas eget eros iaculis, interdum tincidunt elit. Vivamus vel blandit nisl. Proin in ornare dolor, convallis porta sem. Mauris rutrum nibh et ornare egestas. Mauris ultricies diam at nunc tristique rutrum. Aliquam varius non leo vel luctus. Vestibulum sagittis scelerisque ante, non faucibus nibh accumsan sed.&#039;;
		$args       = array_fill( 0, 15, $dummy_text );

		for ( $i = 1; $i &lt;= 100; $i++ ) {
			$timestamp = $timestamp_base + $i;
			$action    = &#039;excessive_test_event_&#039; . $i;
			wp_schedule_single_event( $timestamp, $action, $args );
		}

		get_option( &#039;cron&#039; );

		$cached = wp_cache_get( \Automattic\WP\Cron_Control\Events_Store::CACHE_KEY );

		$this-&gt;assertArrayHasKey( &#039;incrementer&#039;, $cached );
		$this-&gt;assertArrayHasKey( &#039;buckets&#039;, $cached );
		$this-&gt;assertArrayHasKey( &#039;event_count&#039;, $cached );

		$this-&gt;assertEquals( 4, $cached[&#039;buckets&#039;] );
		$this-&gt;assertEquals( 100, $cached[&#039;event_count&#039;] );
	}

	/**
	 * Test retrieving an event without requesting a status
	 */
	function test_get_job_by_attributes() {
		$event = Utils::create_test_event();

		$event_from_store = \Automattic\WP\Cron_Control\get_event_by_attributes(
			[
				&#039;timestamp&#039; =&gt; $event[&#039;timestamp&#039;],
				&#039;action&#039;    =&gt; $event[&#039;action&#039;],
				&#039;instance&#039;  =&gt; md5( maybe_serialize( $event[&#039;args&#039;] ) ),
			]
		);

		$this-&gt;assertInternalType( &#039;object&#039;, $event_from_store );
	}

	/**
	 * Test retrieving an event with any status
	 */
	function test_get_job_by_attributes_with_any_status() {
		$event = Utils::create_test_event();

		$event_from_store = \Automattic\WP\Cron_Control\get_event_by_attributes(
			[
				&#039;timestamp&#039; =&gt; $event[&#039;timestamp&#039;],
				&#039;action&#039;    =&gt; $event[&#039;action&#039;],
				&#039;instance&#039;  =&gt; md5( maybe_serialize( $event[&#039;args&#039;] ) ),
				&#039;status&#039;    =&gt; &#039;any&#039;,
			]
		);

		$this-&gt;assertInternalType( &#039;object&#039;, $event_from_store );
	}

	/**
	 * Test retrieving an event with insufficient information
	 */
	function test_get_job_by_attributes_with_insufficient_args() {
		$event = Utils::create_test_event();

		$event_from_store = \Automattic\WP\Cron_Control\get_event_by_attributes(
			[
				&#039;timestamp&#039; =&gt; $event[&#039;timestamp&#039;],
				&#039;action&#039;    =&gt; $event[&#039;action&#039;],
			]
		);

		$this-&gt;assertFalse( $event_from_store );
	}
}
</code></pre>
            </article>
                <section data-search-results class="phpdocumentor-search-results phpdocumentor-search-results--hidden">
    <section class="phpdocumentor-search-results__dialog">
        <header class="phpdocumentor-search-results__header">
            <h2 class="phpdocumentor-search-results__title">Search results</h2>
            <button class="phpdocumentor-search-results__close"><i class="fas fa-times"></i></button>
        </header>
        <section class="phpdocumentor-search-results__body">
            <ul class="phpdocumentor-search-results__entries"></ul>
        </section>
    </section>
</section>
            </div>
        </div>
        <a href="files/cron-control-tests-tests-class-events-store-tests.html#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <script>
        cssVars({});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
</body>
</html>
