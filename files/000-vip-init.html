<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>VIP Go mu-plugins</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="../">
    <link rel="icon" href="images/favicon.ico"/>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/base.css">
            <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="css/template.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/themes/prism-okaidia.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.css">
            <script src="js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-header phpdocumentor-section">
    <h1 class="phpdocumentor-title"><a href="" class="phpdocumentor-title__link">VIP Go mu-plugins</a><span class="title-separator">/</span>mu-plugins</h1>
    <input class="phpdocumentor-header__menu-button" type="checkbox" id="menu-button" name="menu-button" />
    <label class="phpdocumentor-header__menu-icon" for="menu-button">
        <i class="fas fa-bars"></i>
    </label>
    <section data-search-form class="phpdocumentor-search">
    <label>
        <span class="visually-hidden">Search for</span>
        <svg class="phpdocumentor-search__icon" width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="7.5" cy="7.5" r="6.5" stroke="currentColor" stroke-width="2"/>
            <line x1="12.4892" y1="12.2727" x2="19.1559" y2="18.9393" stroke="currentColor" stroke-width="3"/>
        </svg>
        <input type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading .." disabled />
    </label>
</section>

    <nav class="phpdocumentor-topnav">
    <ul class="phpdocumentor-topnav__menu">
        </ul>
</nav>
</header>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <input class="phpdocumentor-sidebar__menu-button" type="checkbox" id="sidebar-button" name="sidebar-button" />
<label class="phpdocumentor-sidebar__menu-icon" for="sidebar-button">
    Menu
</label>
<aside class="phpdocumentor-column -four phpdocumentor-sidebar">
        
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="namespaces/automattic-wp.html"><abbr title="\Automattic\WP">WP</abbr></a></li>
                                            <li><a href="namespaces/automattic-vip.html"><abbr title="\Automattic\VIP">VIP</abbr></a></li>
                                    </ul>
                            <h4 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/tubalmartin.html"><abbr title="\tubalmartin">tubalmartin</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="namespaces/tubalmartin-cssmin.html"><abbr title="\tubalmartin\CssMin">CssMin</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/VIP.html"><abbr title="\VIP">VIP</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/a8c.html"><abbr title="\a8c">a8c</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/a8c-Cron.html"><abbr title="\a8c\Cron">Cron</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/Http.html"><abbr title="\Http">Http</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/Http-Concat.html"><abbr title="\Http\Concat">Concat</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/ES.html"><abbr title="\ES">ES</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/ES-WP.html"><abbr title="\ES\WP">WP</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/wp.html"><abbr title="\wp">wp</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/wp-cli.html"><abbr title="\wp\cli">cli</abbr></a></li>
                            </ul>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="hooks/hooks.html">Hooks</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">000-vip-init.php</h2>

            <p class="phpdocumentor-summary">Plugin Name: VIP Init
Description: Initializes critical elements of the VIP environment.</p>

    <section class="phpdocumentor-description"><p>Author: Automattic
License: GPL version 2 or later - http://www.gnu.org/licenses/old-licenses/gpl-2.0.html</p>
<p>Remember vip-init.php? This is like that, but better!</p>
</section>











        

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php

/**
 * Plugin Name: VIP Init
 * Description: Initializes critical elements of the VIP environment.
 * Author: Automattic
 * License: GPL version 2 or later - http://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * Remember vip-init.php? This is like that, but better!
 */

/**
 * By virtue of the filename, this file is included first of
 * all the files in the VIP Go MU plugins directory. All
 * VIP code should be initialised here, unless there&#039;s a
 * good reason not to.
 */

// Execute the healthcheck as quickly as possible
if ( &#039;/cache-healthcheck?&#039; === $_SERVER[&#039;REQUEST_URI&#039;] ) {
	if ( function_exists( &#039;newrelic_end_transaction&#039; ) ) {
		// Discard the transaction (the `true` param)
		// See: https://docs.newrelic.com/docs/agents/php-agent/configuration/php-agent-api#api-end-txn
		newrelic_end_transaction( true );
	}

	http_response_code( 200 );

	die( &#039;ok&#039; );
}

// Sites can be blocked for various reasons - usually maintenance, so exit
// early if the constant has been set (defined by VIP Go in config/wp-config.php)
if ( defined( &#039;WPCOM_VIP_SITE_MAINTENANCE_MODE&#039; ) &amp;&amp; WPCOM_VIP_SITE_MAINTENANCE_MODE ) {
	// WP CLI is allowed, but disable cron
	if ( defined( &#039;WP_CLI&#039; ) &amp;&amp; WP_CLI ) {
		add_filter( &#039;pre_option_a8c_cron_control_disable_run&#039;, function() {
			return 1;
		}, 9999 );
	} else {
		// Don&#039;t try to short-circuit Jetpack requests, otherwise it will break the connection.
		require_once __DIR__ . &#039;/vip-helpers/vip-utils.php&#039;;
		if ( ! vip_is_jetpack_request() ) {
			http_response_code( 503 );

			header( &#039;X-VIP-Go-Maintenance: true&#039; );
			// phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
			echo file_get_contents( __DIR__ . &#039;/errors/site-maintenance.html&#039; );

			exit;
		}
	}
}

if ( file_exists( __DIR__ . &#039;/.secrets/vip-secrets.php&#039; ) ) {
	require __DIR__ . &#039;/.secrets/vip-secrets.php&#039;;
}

require_once __DIR__ . &#039;/lib/environment/class-environment.php&#039;;

if ( ! defined( &#039;A8C_PROXIED_REQUEST&#039; ) ) {
	/**
	 * @var constant A8C_PROXIED_REQUEST Set to true if the current request is made via the Automattic proxy, which is only available to Automatticians.
	 */
	define( &#039;A8C_PROXIED_REQUEST&#039;, false );
}

if ( ! defined( &#039;VIP_GO_ENV&#039; ) ) {
	/**
	 * @constant VIP_GO_ENV The name of the current VIP Go environment. Falls back to `false`.
	 */
	define( &#039;VIP_GO_ENV&#039;, false );
}

// On VIP Go environments this will already be set to true in wp-config.php
// Default to false for other environments, e.g. local development
if ( ! defined( &#039;WPCOM_IS_VIP_ENV&#039; ) ) {
	define( &#039;WPCOM_IS_VIP_ENV&#039;, false );
}

define( &#039;WPCOM_SANDBOXED&#039;, \Automattic\VIP\Environment::is_sandbox_container( gethostname(), $_ENV ) );
define( &#039;VIP_GO_IS_CLI_CONTAINER&#039;, \Automattic\VIP\Environment::is_batch_container( gethostname(), $_ENV ) );

// Used to verify emails sent via our SMTP servers
if ( ! defined( &#039;WPCOM_VIP_MAIL_TRACKING_KEY&#039; ) ) {
	define( &#039;WPCOM_VIP_MAIL_TRACKING_KEY&#039;, false );
}

// Define constants for custom VIP Go paths
define( &#039;WPCOM_VIP_CLIENT_MU_PLUGIN_DIR&#039;, WP_CONTENT_DIR . &#039;/client-mu-plugins&#039; );

$private_dir_path = WP_CONTENT_DIR . &#039;/private&#039;; // Local fallback
if ( false !== VIP_GO_ENV ) {
	if ( is_dir( &#039;/private&#039; ) ) {
		$private_dir_path = &#039;/private&#039;;
	} elseif ( is_dir( &#039;/chroot/private&#039; ) ) {
		$private_dir_path = &#039;/chroot/private&#039;;
	}
}
define( &#039;WPCOM_VIP_PRIVATE_DIR&#039;, $private_dir_path );
unset( $private_dir_path );

// Define these values just in case
defined( &#039;WPCOM_VIP_MACHINE_USER_LOGIN&#039; ) or define( &#039;WPCOM_VIP_MACHINE_USER_LOGIN&#039;, &#039;vip&#039; );
defined( &#039;WPCOM_VIP_MACHINE_USER_NAME&#039; )  or define( &#039;WPCOM_VIP_MACHINE_USER_NAME&#039;, &#039;VIP&#039; );
defined( &#039;WPCOM_VIP_MACHINE_USER_EMAIL&#039; ) or define( &#039;WPCOM_VIP_MACHINE_USER_EMAIL&#039;, &#039;donotreply@wordpress.com&#039; );
defined( &#039;WPCOM_VIP_MACHINE_USER_ROLE&#039; )  or define( &#039;WPCOM_VIP_MACHINE_USER_ROLE&#039;, &#039;administrator&#039; );

add_action( &#039;set_current_user&#039;, function() {
	$user = get_user_by( &#039;login&#039;, WPCOM_VIP_MACHINE_USER_LOGIN );

	if ( $user &amp;&amp; $user-&gt;ID ) {
		defined( &#039;WPCOM_VIP_MACHINE_USER_ID&#039; ) or define( &#039;WPCOM_VIP_MACHINE_USER_ID&#039;, $user-&gt;ID );
	}
}, PHP_INT_MIN );

// Support a limited number of additional &quot;Internal Events&quot; in Cron Control.
// These events run regardless of the number of pending events, and they cannot be deleted.
$internal_cron_events = array(
	array(
		&#039;schedule&#039; =&gt; &#039;hourly&#039;,
		&#039;action&#039;   =&gt; &#039;wpcom_vip_support_remove_user_via_cron&#039;, // Automattic\VIP\Support_User\User::CRON_ACTION
		&#039;callback&#039; =&gt; array( &#039;Automattic\VIP\Support_User\User&#039;, &#039;do_cron_cleanup&#039; ),
	)
);

// JP Connection Pilot disabled by default
if ( ! defined( &#039;VIP_JETPACK_CONNECTION_PILOT_SHOULD_RUN&#039; ) ) {
	define( &#039;VIP_JETPACK_CONNECTION_PILOT_SHOULD_RUN&#039;, false );
}

// JP Connection Pilot auto-reconnect disabled by default
if ( ! defined( &#039;VIP_JETPACK_CONNECTION_PILOT_SHOULD_RECONNECT&#039; ) ) {
	define( &#039;VIP_JETPACK_CONNECTION_PILOT_SHOULD_RECONNECT&#039;, false );
}

if ( defined( &#039;VIP_JETPACK_CONNECTION_PILOT_SHOULD_RUN&#039; ) &amp;&amp; true === VIP_JETPACK_CONNECTION_PILOT_SHOULD_RUN ) {
	$internal_cron_events[] = array(
		&#039;schedule&#039;  =&gt; &#039;hourly&#039;,
		&#039;action&#039;    =&gt; &#039;wpcom_vip_run_jetpack_connection_pilot&#039;,
		&#039;callback&#039;  =&gt; array( &#039;\Automattic\VIP\Jetpack\Connection_Pilot&#039;, &#039;do_cron&#039; ),
		&#039;timestamp&#039; =&gt; strtotime( sprintf( &#039;+%d minutes&#039;, mt_rand( 1, 60 ) ) ),
	);
}

define( &#039;CRON_CONTROL_ADDITIONAL_INTERNAL_EVENTS&#039;, $internal_cron_events );

// Interaction with the filesystem will always be direct.
// Avoids issues with `get_filesystem_method` which attempts to write to `WP_CONTENT_DIR` and fails.
define( &#039;FS_METHOD&#039;, &#039;direct&#039; );

if ( WPCOM_SANDBOXED ) {
	require __DIR__ . &#039;/vip-helpers/sandbox.php&#039;;
}

// Feature flags
require_once( __DIR__ . &#039;/lib/feature/class-feature.php&#039; );

// Logging
require_once( __DIR__ . &#039;/logstash/logstash.php&#039; );
require_once( __DIR__ . &#039;/lib/statsd/class-statsd.php&#039; );

// Debugging Tools
require_once( __DIR__ . &#039;/000-debug/0-load.php&#039; );
require_once( __DIR__ . &#039;/lib/utils/class-alerts.php&#039; );

// Load our development and environment helpers
require_once( __DIR__ . &#039;/vip-helpers/vip-notoptions-mitigation.php&#039; );
require_once( __DIR__ . &#039;/vip-helpers/vip-utils.php&#039; );
require_once( __DIR__ . &#039;/vip-helpers/vip-newrelic.php&#039; );
require_once( __DIR__ . &#039;/vip-helpers/vip-caching.php&#039; );
require_once( __DIR__ . &#039;/vip-helpers/vip-roles.php&#039; );
require_once( __DIR__ . &#039;/vip-helpers/vip-permastructs.php&#039; );
require_once( __DIR__ . &#039;/vip-helpers/vip-mods.php&#039; );
require_once( __DIR__ . &#039;/vip-helpers/vip-media.php&#039; );
require_once( __DIR__ . &#039;/vip-helpers/vip-elasticsearch.php&#039; );
require_once( __DIR__ . &#039;/vip-helpers/vip-stats.php&#039; );
require_once( __DIR__ . &#039;/vip-helpers/vip-deprecated.php&#039; );
require_once( __DIR__ . &#039;/vip-helpers/vip-syndication-cache.php&#039; );
require_once( __DIR__ . &#039;/vip-helpers/vip-migrations.php&#039; );

//enabled on selected sites for now
if ( true === defined( &#039;WPCOM_VIP_CLEAN_TERM_CACHE&#039; ) &amp;&amp; true === constant( &#039;WPCOM_VIP_CLEAN_TERM_CACHE&#039; ) ) {
	require_once dirname( __FILE__ ) . &#039;/vip-helpers/vip-clean-term-cache.php&#039;;
}

// Load WP_CLI helpers
if ( defined( &#039;WP_CLI&#039; ) &amp;&amp; WP_CLI ) {
	require_once( __DIR__ . &#039;/vip-helpers/vip-wp-cli.php&#039; );
	require_once( __DIR__ . &#039;/vip-helpers/class-vip-backup-user-role-cli.php&#039; );
}

// Load elasticsearch helpers
// Warning: Site Details depends on the existence of class Search.
// If this changes in the future, please ensure that details for search are correctly extracted
if ( ( defined( &#039;USE_VIP_ELASTICSEARCH&#039; ) &amp;&amp; USE_VIP_ELASTICSEARCH ) || // legacy constant name
	defined( &#039;VIP_ENABLE_VIP_SEARCH&#039; ) &amp;&amp; true === VIP_ENABLE_VIP_SEARCH ) {
	require_once( __DIR__ . &#039;/search/search.php&#039; );

	$search_plugin = \Automattic\VIP\Search\Search::instance();

	// If VIP Search query integration is enabled, disable Jetpack Search
	if ( ! $search_plugin::ep_skip_query_integration( false ) ) {
		add_filter( &#039;jetpack_active_modules&#039;, array( $search_plugin, &#039;filter__jetpack_active_modules&#039; ), PHP_INT_MAX );
		add_filter( &#039;jetpack_widgets_to_include&#039;, array( $search_plugin, &#039;filter__jetpack_widgets_to_include&#039; ), PHP_INT_MAX );
		add_filter( &#039;jetpack_search_should_handle_query&#039;, &#039;__return_false&#039;, PHP_INT_MAX );
	}
}

// Set WordPress environment type
// Map some VIP environments to &#039;production&#039; and &#039;development&#039;, and use &#039;staging&#039; for any other
if ( defined( &#039;VIP_GO_APP_ENVIRONMENT&#039; ) &amp;&amp; ! defined( &#039;WP_ENVIRONMENT_TYPE&#039; ) ) {
	switch ( VIP_GO_APP_ENVIRONMENT ) {
		case &#039;production&#039;:
			$environment_type = &#039;production&#039;;
			break;
		case &#039;develop&#039;:
		case &#039;development&#039;:
			$environment_type = &#039;development&#039;;
			break;
		default:
			$environment_type = &#039;staging&#039;;
			break;
	}

	define( &#039;WP_ENVIRONMENT_TYPE&#039;, $environment_type );

	// VIP sites should not be set as staging in Jetpack
	// since it breaks SSO and prevents data from being passed to
	// WordPress.com
	add_filter( &#039;jetpack_is_staging_site&#039;, &#039;__return_false&#039; );
}

// Load config related helpers
require_once( __DIR__ . &#039;/config/class-sync.php&#039; );

add_action( &#039;init&#039;, function() {
	\Automattic\VIP\Config\Sync::instance();
} );

// Load _encloseme meta cleanup scheduler
require_once( __DIR__ . &#039;/lib/class-vip-encloseme-cleanup.php&#039; );

$encloseme_cleaner = new VIP_Encloseme_Cleanup();
$encloseme_cleaner-&gt;init();

// Add custom header for VIP
add_filter( &#039;wp_headers&#039;, function( $headers ) {
	$headers[&#039;X-hacker&#039;] = &#039;If you\&#039;re reading this, you should visit wpvip.com/careers and apply to join the fun, mention this header.&#039;;
	$headers[&#039;X-Powered-By&#039;] = &#039;WordPress VIP &lt;https://wpvip.com&gt;&#039;;
	$headers[&#039;Host-Header&#039;] = &#039;a9130478a60e5f9135f765b23f26593b&#039;; // md5 -s wpvip

	// Non-production applications and go-vip.(co|net) domains should not be indexed.
	if ( &#039;production&#039; !== VIP_GO_ENV || false !== strpos( $_SERVER[ &#039;HTTP_HOST&#039; ], &#039;.go-vip.&#039; ) ) {
		$headers[&#039;X-Robots-Tag&#039;] = &#039;noindex, nofollow&#039;;
	}

	return $headers;
} );

// Disable core sitemaps
//
// https://make.wordpress.org/core/2020/07/22/new-xml-sitemaps-functionality-in-wordpress-5-5/
add_filter( &#039;wp_sitemaps_enabled&#039;, &#039;__return_false&#039; );

do_action( &#039;vip_loaded&#039; );
</code></pre>
            </article>
                <section data-search-results class="phpdocumentor-search-results phpdocumentor-search-results--hidden">
    <section class="phpdocumentor-search-results__dialog">
        <header class="phpdocumentor-search-results__header">
            <h2 class="phpdocumentor-search-results__title">Search results</h2>
            <button class="phpdocumentor-search-results__close"><i class="fas fa-times"></i></button>
        </header>
        <section class="phpdocumentor-search-results__body">
            <ul class="phpdocumentor-search-results__entries"></ul>
        </section>
    </section>
</section>
            </div>
        </div>
        <a href="files/000-vip-init.html#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <script>
        cssVars({});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
</body>
</html>
