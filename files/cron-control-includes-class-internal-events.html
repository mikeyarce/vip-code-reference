<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>VIP Go mu-plugins</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="../">
    <link rel="icon" href="images/favicon.ico"/>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/base.css">
            <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="css/template.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/themes/prism-okaidia.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.css">
            <script src="js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-header phpdocumentor-section">
    <h1 class="phpdocumentor-title"><a href="" class="phpdocumentor-title__link">VIP Go mu-plugins</a><span class="title-separator">/</span>mu-plugins</h1>
    <input class="phpdocumentor-header__menu-button" type="checkbox" id="menu-button" name="menu-button" />
    <label class="phpdocumentor-header__menu-icon" for="menu-button">
        <i class="fas fa-bars"></i>
    </label>
    <section data-search-form class="phpdocumentor-search">
    <label>
        <span class="visually-hidden">Search for</span>
        <svg class="phpdocumentor-search__icon" width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="7.5" cy="7.5" r="6.5" stroke="currentColor" stroke-width="2"/>
            <line x1="12.4892" y1="12.2727" x2="19.1559" y2="18.9393" stroke="currentColor" stroke-width="3"/>
        </svg>
        <input type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading .." disabled />
    </label>
</section>

    <nav class="phpdocumentor-topnav">
    <ul class="phpdocumentor-topnav__menu">
        </ul>
</nav>
</header>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <input class="phpdocumentor-sidebar__menu-button" type="checkbox" id="sidebar-button" name="sidebar-button" />
<label class="phpdocumentor-sidebar__menu-icon" for="sidebar-button">
    Menu
</label>
<aside class="phpdocumentor-column -four phpdocumentor-sidebar">
        
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
                                <h3 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/default.html"><abbr title="\">Global</abbr></a></h3>
                                        <h4 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/automattic.html"><abbr title="\Automattic">Automattic</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="namespaces/automattic-wp.html"><abbr title="\Automattic\WP">WP</abbr></a></li>
                                            <li><a href="namespaces/automattic-vip.html"><abbr title="\Automattic\VIP">VIP</abbr></a></li>
                                    </ul>
                            <h4 class="phpdocumentor-sidebar__root-namespace"><a href="namespaces/tubalmartin.html"><abbr title="\tubalmartin">tubalmartin</abbr></a></h4>
                <ul class="phpdocumentor-list">
                                            <li><a href="namespaces/tubalmartin-cssmin.html"><abbr title="\tubalmartin\CssMin">CssMin</abbr></a></li>
                                    </ul>
                        </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/VIP.html"><abbr title="\VIP">VIP</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/a8c.html"><abbr title="\a8c">a8c</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/a8c-Cron.html"><abbr title="\a8c\Cron">Cron</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/Http.html"><abbr title="\Http">Http</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/Http-Concat.html"><abbr title="\Http\Concat">Concat</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/ES.html"><abbr title="\ES">ES</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/ES-WP.html"><abbr title="\ES\WP">WP</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="packages/wp.html"><abbr title="\wp">wp</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="packages/wp-cli.html"><abbr title="\wp\cli">cli</abbr></a></li>
                            </ul>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="hooks/hooks.html">Hooks</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-internal-events.php</h2>

            <p class="phpdocumentor-summary">Internal events to manage plugin and common WP cron complaints</p>

    <section class="phpdocumentor-description"></section>






<h3 id="interfaces_class_traits">
    Interfaces, Classes and Traits
    <a href="#interfaces_class_traits" class="headerlink"><i class="fas fa-link"></i></a>
</h3>

<dl class="phpdocumentor-table-of-contents">
    
            <dt class="phpdocumentor-table-of-contents__entry -class"><a href="classes/Automattic-WP-Cron-Control-Internal-Events.html"><abbr title="\Automattic\WP\Cron_Control\Internal_Events">Internal_Events</abbr></a></dt>
        <dd>Internal Events class</dd>
    
    </dl>





        

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * Internal events to manage plugin and common WP cron complaints
 *
 * @package a8c_Cron_Control
 */

namespace Automattic\WP\Cron_Control;

/**
 * Internal Events class
 */
class Internal_Events extends Singleton {
	/**
	 * PLUGIN SETUP
	 */

	/**
	 * List of registered internal events
	 *
	 * @var array
	 */
	private $internal_events = array();

	/**
	 * Schedules for internal events
	 *
	 * Provides for intervals shorter than Core does by default
	 *
	 * @var array
	 */
	private $internal_events_schedules = array();

	/**
	 * Register hooks
	 */
	protected function class_init() {
		// Prepare events and their schedules, allowing for additions.
		$this-&gt;prepare_internal_events();
		$this-&gt;prepare_internal_events_schedules();

		// Register hooks.
		if ( defined( &#039;WP_CLI&#039; ) &amp;&amp; \WP_CLI ) {
			add_action( &#039;wp_loaded&#039;, array( $this, &#039;schedule_internal_events&#039; ) );
		} else {
			add_action( &#039;admin_init&#039;, array( $this, &#039;schedule_internal_events&#039; ) );
		}

		add_filter( &#039;cron_schedules&#039;, array( $this, &#039;register_internal_events_schedules&#039; ) );

		foreach ( $this-&gt;internal_events as $internal_event ) {
			add_action( $internal_event[&#039;action&#039;], $internal_event[&#039;callback&#039;] );
		}
	}

	/**
	 * Populate internal events, allowing for additions
	 */
	private function prepare_internal_events() {
		$internal_events = array(
			array(
				&#039;schedule&#039; =&gt; &#039;a8c_cron_control_minute&#039;,
				&#039;action&#039;   =&gt; &#039;a8c_cron_control_force_publish_missed_schedules&#039;,
				&#039;callback&#039; =&gt; array( $this, &#039;force_publish_missed_schedules&#039; ),
			),
			array(
				&#039;schedule&#039; =&gt; &#039;a8c_cron_control_ten_minutes&#039;,
				&#039;action&#039;   =&gt; &#039;a8c_cron_control_confirm_scheduled_posts&#039;,
				&#039;callback&#039; =&gt; array( $this, &#039;confirm_scheduled_posts&#039; ),
			),
			array(
				&#039;schedule&#039; =&gt; &#039;daily&#039;,
				&#039;action&#039;   =&gt; &#039;a8c_cron_control_clean_legacy_data&#039;,
				&#039;callback&#039; =&gt; array( $this, &#039;clean_legacy_data&#039; ),
			),
			array(
				&#039;schedule&#039; =&gt; &#039;hourly&#039;,
				&#039;action&#039;   =&gt; &#039;a8c_cron_control_purge_completed_events&#039;,
				&#039;callback&#039; =&gt; array( $this, &#039;purge_completed_events&#039; ),
			),
		);

		// Allow additional internal events to be specified, ensuring the above cannot be overwritten.
		if ( defined( &#039;CRON_CONTROL_ADDITIONAL_INTERNAL_EVENTS&#039; ) &amp;&amp; is_array( \CRON_CONTROL_ADDITIONAL_INTERNAL_EVENTS ) ) {
			$internal_actions = wp_list_pluck( $internal_events, &#039;action&#039; );

			foreach ( \CRON_CONTROL_ADDITIONAL_INTERNAL_EVENTS as $additional ) {
				if ( in_array( $additional[&#039;action&#039;], $internal_actions, true ) ) {
					continue;
				}

				if ( ! array_key_exists( &#039;schedule&#039;, $additional ) || ! array_key_exists( &#039;action&#039;, $additional ) || ! array_key_exists( &#039;callback&#039;, $additional ) ) {
					continue;
				}

				$internal_events[] = $additional;
			}
		}

		$this-&gt;internal_events = $internal_events;
	}

	/**
	 * Allow custom internal events to provide their own schedules
	 */
	private function prepare_internal_events_schedules() {
		$internal_events_schedules = array(
			&#039;a8c_cron_control_minute&#039;      =&gt; array(
				&#039;interval&#039; =&gt; 2 * MINUTE_IN_SECONDS,
				&#039;display&#039;  =&gt; __( &#039;Cron Control internal job - every 2 minutes (used to be 1 minute)&#039;, &#039;automattic-cron-control&#039; ),
			),
			&#039;a8c_cron_control_ten_minutes&#039; =&gt; array(
				&#039;interval&#039; =&gt; 10 * MINUTE_IN_SECONDS,
				&#039;display&#039;  =&gt; __( &#039;Cron Control internal job - every 10 minutes&#039;, &#039;automattic-cron-control&#039; ),
			),
		);

		// Allow additional schedules for custom events, ensuring the above cannot be overwritten.
		if ( defined( &#039;CRON_CONTROL_ADDITIONAL_INTERNAL_EVENTS_SCHEDULES&#039; ) &amp;&amp; is_array( \CRON_CONTROL_ADDITIONAL_INTERNAL_EVENTS_SCHEDULES ) ) {
			foreach ( \CRON_CONTROL_ADDITIONAL_INTERNAL_EVENTS_SCHEDULES as $name =&gt; $attrs ) {
				if ( array_key_exists( $name, $internal_events_schedules ) ) {
					continue;
				}

				if ( ! array_key_exists( &#039;interval&#039;, $attrs ) || ! array_key_exists( &#039;display&#039;, $attrs ) ) {
					continue;
				}

				$internal_events_schedules[ $name ] = $attrs;
			}
		}

		$this-&gt;internal_events_schedules = $internal_events_schedules;
	}

	/**
	 * Include custom schedules used for internal events
	 *
	 * @param array $schedules List of registered event intervals.
	 * @return array
	 */
	public function register_internal_events_schedules( $schedules ) {
		return array_merge( $schedules, $this-&gt;internal_events_schedules );
	}

	/**
	 * Schedule internal events
	 */
	public function schedule_internal_events() {
		$when = strtotime( sprintf( &#039;+%d seconds&#039;, JOB_QUEUE_WINDOW_IN_SECONDS ) );

		$schedules = wp_get_schedules();

		foreach ( $this-&gt;internal_events as $event_args ) {
			if ( ! wp_next_scheduled( $event_args[&#039;action&#039;] ) ) {
				$interval = array_key_exists( $event_args[&#039;schedule&#039;], $schedules ) ? $schedules[ $event_args[&#039;schedule&#039;] ][&#039;interval&#039;] : 0;

				$args = array(
					&#039;schedule&#039; =&gt; $event_args[&#039;schedule&#039;],
					&#039;args&#039;     =&gt; array(),
					&#039;interval&#039; =&gt; $interval,
				);

				schedule_event( $when, $event_args[&#039;action&#039;], $args );
			}
		}
	}

	/**
	 * PLUGIN UTILITIES
	 */

	/**
	 * Events that are always run, regardless of how many jobs are queued
	 *
	 * @param string $action Event action.
	 * @return bool
	 */
	public function is_internal_event( $action ) {
		return in_array( $action, wp_list_pluck( $this-&gt;internal_events, &#039;action&#039; ), true );
	}

	/**
	 * EVENT CALLBACKS
	 */

	/**
	 * Publish scheduled posts that miss their schedule
	 */
	public function force_publish_missed_schedules() {
		global $wpdb;

		$missed_posts = $wpdb-&gt;get_col( $wpdb-&gt;prepare( &quot;SELECT ID FROM {$wpdb-&gt;posts} WHERE post_status = &#039;future&#039; AND post_date &lt;= %s LIMIT 0,100;&quot;, current_time( &#039;mysql&#039;, false ) ) );

		foreach ( $missed_posts as $missed_post ) {
			$missed_post = absint( $missed_post );
			wp_publish_post( $missed_post );
			wp_clear_scheduled_hook( &#039;publish_future_post&#039;, array( $missed_post ) );

			do_action( &#039;a8c_cron_control_published_post_that_missed_schedule&#039;, $missed_post );
		}
	}

	/**
	 * Ensure scheduled posts have a corresponding cron job to publish them
	 */
	public function confirm_scheduled_posts() {
		global $wpdb;

		$page     = 1;
		$quantity = 100;

		do {
			$offset       = max( 0, $page - 1 ) * $quantity;
			$future_posts = $wpdb-&gt;get_results( $wpdb-&gt;prepare( &quot;SELECT ID, post_date FROM {$wpdb-&gt;posts} WHERE post_status = &#039;future&#039; AND post_date &gt; %s LIMIT %d,%d&quot;, current_time( &#039;mysql&#039;, false ), $offset, $quantity ) );

			if ( ! empty( $future_posts ) ) {
				foreach ( $future_posts as $future_post ) {
					$future_post-&gt;ID = absint( $future_post-&gt;ID );
					$gmt_time        = strtotime( get_gmt_from_date( $future_post-&gt;post_date ) . &#039; GMT&#039; );
					$timestamp       = wp_next_scheduled( &#039;publish_future_post&#039;, array( $future_post-&gt;ID ) );

					if ( false === $timestamp ) {
						wp_schedule_single_event( $gmt_time, &#039;publish_future_post&#039;, array( $future_post-&gt;ID ) );

						do_action( &#039;a8c_cron_control_publish_scheduled&#039;, $future_post-&gt;ID );
					} elseif ( (int) $timestamp !== $gmt_time ) {
						wp_clear_scheduled_hook( &#039;publish_future_post&#039;, array( $future_post-&gt;ID ) );
						wp_schedule_single_event( $gmt_time, &#039;publish_future_post&#039;, array( $future_post-&gt;ID ) );

						do_action( &#039;a8c_cron_control_publish_rescheduled&#039;, $future_post-&gt;ID );
					}
				}
			}

			$page++;

			if ( count( $future_posts ) &lt; $quantity || $page &gt; 5 ) {
				break;
			}
		} while ( ! empty( $future_posts ) );
	}

	/**
	 * Remove unnecessary data and scheduled events
	 *
	 * Some of this data relates to how Core manages Cron when this plugin isn&#039;t active
	 */
	public function clean_legacy_data() {
		// Cron option can be very large, so it shouldn&#039;t linger.
		delete_option( &#039;cron&#039; );

		// While this plugin doesn&#039;t use this locking mechanism, other code may check the value.
		if ( wp_using_ext_object_cache() ) {
			wp_cache_delete( &#039;doing_cron&#039;, &#039;transient&#039; );
		} else {
			delete_transient( &#039;doing_cron&#039; );
		}

		// Confirm internal events are scheduled for when they&#039;re expected.
		$schedules = wp_get_schedules();

		foreach ( $this-&gt;internal_events as $internal_event ) {
			$timestamp = wp_next_scheduled( $internal_event[&#039;action&#039;] );

			// Will reschedule on its own.
			if ( false === $timestamp ) {
				continue;
			}

			$event_details = get_event_by_attributes(
				array(
					&#039;timestamp&#039; =&gt; $timestamp,
					&#039;action&#039;    =&gt; $internal_event[&#039;action&#039;],
					&#039;instance&#039;  =&gt; md5( maybe_serialize( array() ) ),
				)
			);

			if ( $event_details-&gt;schedule !== $internal_event[&#039;schedule&#039;] ) {
				if ( $timestamp &lt;= time() ) {
					$timestamp = time() + ( 1 * \MINUTE_IN_SECONDS );
				}

				$args = array(
					&#039;schedule&#039; =&gt; $internal_event[&#039;schedule&#039;],
					&#039;args&#039;     =&gt; $event_details-&gt;args,
					&#039;interval&#039; =&gt; $schedules[ $internal_event[&#039;schedule&#039;] ][&#039;interval&#039;],
				);

				schedule_event( $timestamp, $event_details-&gt;action, $args, $event_details-&gt;ID );
			}
		}
	}

	/**
	 * Delete event objects for events that have run
	 */
	public function purge_completed_events() {
		Events_Store::instance()-&gt;purge_completed_events();
	}
}

Internal_Events::instance();
</code></pre>
            </article>
                <section data-search-results class="phpdocumentor-search-results phpdocumentor-search-results--hidden">
    <section class="phpdocumentor-search-results__dialog">
        <header class="phpdocumentor-search-results__header">
            <h2 class="phpdocumentor-search-results__title">Search results</h2>
            <button class="phpdocumentor-search-results__close"><i class="fas fa-times"></i></button>
        </header>
        <section class="phpdocumentor-search-results__body">
            <ul class="phpdocumentor-search-results__entries"></ul>
        </section>
    </section>
</section>
            </div>
        </div>
        <a href="files/cron-control-includes-class-internal-events.html#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <script>
        cssVars({});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
</body>
</html>
